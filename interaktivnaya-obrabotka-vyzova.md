# Интерактивная обработка вызова

Эта технология позволит:

* автоматизировать учет входящих звонков во внешней системе (CRM);
* CRM-системе диктовать виртуальной АТС решение о способе обработки вызовов;
* персонализировать обработку звонков.

## Настройка внешней системы

На стороне внешней системы реализуйте http-сервер, который будет получать запрос о входящих звонках от виртуальной АТС, а взамен отправлять инструкцию по их дальнейшей обработке. Запрос — обращение на определенный URL с параметрами вызова, вида

```
http://crm11.getsandbox.com/crm_integration?cdr_id=123&start_time=1200&input_result=None&numa=74952345678&numb=74951234567
```

где:

*   [http://crm11.getsandbox.com/crm_integration](http://crm11.getsandbox.com/crm_integration) — URL обработчика запросов виртуальной АТС;
*   `cdr_id` — идентификатор звонка;
*   `start_time` — время начала звонка;
*   `input_result` — введенные звонящим коды DTMF;
*   `numa` — номер звонящего;
*   `numb` — номер, на который звонят.

[![](https://github.com/andrey149502/comagic-api/blob/master/images/iov-pic-1.jpg)](#)

Сервер должен прислать успешный (со статусом 200) http-ответ, в котором будет инструкция для виртуальной АТС — JSON-структура одного из следующих форматов:


**Переадресация**

```
{
  "phones": список номеров,
  "message_name": имя файла в базе
  или
  "text": текст для произнесения
}
```

Используется, когда внешняя система включает сценарий переадресации звонка на другой номер (номера) с воспроизведением сообщения пользователю. Например:

```json
{
  "phones": ["74959876543", "79031505050", "74951234567"],
  "message_name": "10sec.mp3"
}
```

```json
{
  "text": "Приветствую",
  "phones": ["79031204040", "79651234567"]
}
```

```json
{
  "message_name": "10sec.mp3"
}
```

```json
{
  "text": "Привет"
}
```

```json
{
  "phones": ["79037897878", "74951234567"]
}
```

```json
{
  "phones": ["74959876543", "79031505050", "74951234567"],
  "message_name": "10sec.mp3",
  "operator_message": "op_hint.mp3"
}
```

Проигрывание сообщения сотруднику перед началом разговора может быть воспроизведено как через настройку операции в Личном кабинете; так и через ответ внешней системы. Оperator_message может быть двух видов: operator_media — воспроизвести фрагмент из базы файлов или operator_text — преобразовать сообщение в голос. Если одновременно диктуются две инструкции operator_media и operator_text, то воспроизведено будет operator_media. При этом ответ внешней системы имеет приоритет над настройкой сообщения сотруднику в Личном кабинете.

**Инструкция о переходе внутри сценария Виртуальной АТС**

```
{
  "returned_code": код возврата
}
```

Используйте, когда необходимо направить обработку вызова по одному из привязанных сценариев. Можно выбрать несколько кодов возврата, обрабатываемых последовательно.

[![](https://github.com/andrey149502/comagic-api/blob/master/images/iov-pic-2.jpg)](#)

## Настройка виртуальной АТС

В сценарии виртуальной АТС создайте операцию интерактивной обработки вызова.

[![](https://github.com/andrey149502/comagic-api/blob/master/images/iov-pic-3.jpg)](#)

В этом сценарии необходимо задать:
*   URL, по которому можно связываться с обработчиком запросов;
*   метод отправки запроса: GET или POST;
*   параметры, которые необходимо включать в запрос (`cdr_id`, `start_time`, `input_result`, `numa`, `numb`);
*   длину кода доступа, если требуется получать от звонящего DTMF.

Также, если будет использоваться инструкция о переходе внутри сценария виртуальной АТС, указывайте связанные операции. Тогда система будет направлять звонок по связанной ветке внутри сценария.

Мы настоятельно рекомендуем настраивать действия виртуальной АТС на случай, если внешняя система по какой-либо причине не даст ответа.